<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Database Migration - Inventory Tracker</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div class="container">
    <header class="header">
      <h1>Database Migration</h1>
      <div class="header-actions">
        <a href="index.html" class="btn secondary">Back to Inventory</a>
      </div>
    </header>

    <section class="card">
      <h2>Database Schema Migration</h2>
      <p>This will add any missing columns to your database tables.</p>
      <button id="migrateBtn" class="btn primary">Run Migration</button>
      <div id="migrateResult"></div>
    </section>

    <section class="card">
      <h2>Inventory System Migration</h2>
      <p>This will migrate your existing inventory items to the new multiple inventory system.</p>
      <button id="migrateInventoriesBtn" class="btn primary">Migrate to Inventories</button>
      <div id="migrateInventoriesResult"></div>
    </section>
    
    <section class="card">
      <h2>Clear All Data (Danger Zone)</h2>
      <p>⚠️ This will permanently delete ALL data from the database. Use only if you want to start completely fresh.</p>
      <button id="clearAllDataBtn" class="btn danger">Clear All Data</button>
      <div id="clearAllDataResult"></div>
    </section>
  </div>

  <script>
    const migrateBtn = document.getElementById('migrateBtn')
    const migrateInventoriesBtn = document.getElementById('migrateInventoriesBtn')
    const clearAllDataBtn = document.getElementById('clearAllDataBtn')
    const migrateResult = document.getElementById('migrateResult')
    const migrateInventoriesResult = document.getElementById('migrateInventoriesResult')
    const clearAllDataResult = document.getElementById('clearAllDataResult')

    migrateBtn.addEventListener('click', async () => {
      try {
        migrateBtn.disabled = true
        migrateBtn.textContent = 'Running...'
        
        const response = await fetch('/api/migrate-db', { method: 'POST' })
        const result = await response.json()
        
        if (response.ok) {
          migrateResult.innerHTML = `<div class="success">${result.message}</div>`
        } else {
          migrateResult.innerHTML = `<div class="error">${result.message}</div>`
        }
      } catch (error) {
        migrateResult.innerHTML = `<div class="error">Error: ${error.message}</div>`
      } finally {
        migrateBtn.disabled = false
        migrateBtn.textContent = 'Run Migration'
      }
    })

    migrateInventoriesBtn.addEventListener('click', async () => {
      try {
        migrateInventoriesBtn.disabled = true
        migrateInventoriesBtn.textContent = 'Running...'
        
        const token = localStorage.getItem('authToken')
        if (!token) {
          migrateInventoriesResult.innerHTML = '<div class="error">Please log in first</div>'
          return
        }
        
        const response = await fetch('/api/migrate-to-inventories', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          },
          body: JSON.stringify({ userId: 1 })
        })
        
        const result = await response.json()
        
        if (response.ok) {
          migrateInventoriesResult.innerHTML = `<div class="success">${result.message}</div>`
        } else {
          migrateInventoriesResult.innerHTML = `<div class="error">${result.message}</div>`
        }
      } catch (error) {
        migrateInventoriesResult.innerHTML = `<div class="error">Error: ${error.message}</div>`
      } finally {
        migrateInventoriesBtn.disabled = false
        migrateInventoriesBtn.textContent = 'Migrate to Inventories'
      }
    })

    clearAllDataBtn.addEventListener('click', async () => {
      if (!confirm('⚠️ WARNING: This will permanently delete ALL data from the database!\n\nThis action cannot be undone. Are you absolutely sure you want to continue?')) {
        return
      }
      
      try {
        clearAllDataBtn.disabled = true
        clearAllDataBtn.textContent = 'Clearing...'
        
        const token = localStorage.getItem('authToken')
        if (!token) {
          clearAllDataResult.innerHTML = '<div class="error">Please log in first</div>'
          return
        }
        
        const response = await fetch('/api/clear-all-data', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
          }
        })
        
        const result = await response.json()
        
        if (response.ok) {
          clearAllDataResult.innerHTML = `<div class="success">${result.message}</div>`
          clearAllDataBtn.textContent = 'Data Cleared Successfully'
        } else {
          clearAllDataResult.innerHTML = `<div class="error">${result.message}</div>`
        }
      } catch (error) {
        clearAllDataResult.innerHTML = `<div class="error">Error: ${error.message}</div>`
      } finally {
        clearAllDataBtn.disabled = false
        if (clearAllDataResult.innerHTML.includes('success')) {
          clearAllDataBtn.textContent = 'Data Cleared Successfully'
        } else {
          clearAllDataBtn.textContent = 'Clear All Data'
        }
      }
    })
  </script>
</body>
</html>
